#!/usr/bin/env bash
#
# Checks if the system requires (security) updates.
#
# Syntax: simple-uptodate [options]
#
# Options:
#   -s, --security     Only check for security updates.
#   -m, --mail         Mail root@localhost instead of printing results.
#

# Configuration parameters
PROCID="simple-uptodate[$$]"
HOST=`hostname`
SENDMAIL=/usr/sbin/sendmail
SECURITY=false
MAIL=false

# Set caution flags
set -o nounset
set -o errtrace
set -o errexit
set -o pipefail

# Function for logging an error to stderr and syslog and exiting
fail() {
    echo "ERROR:" "$@" >&2
    logger -p local0.error -t "$PROCID" "$@" || true
    exit 1
}

# Function for printing command-line usage info
usage() {
    echo "Checks if the system requires (security) updates."
    echo
    echo "Syntax: simple-uptodate [options]"
    echo
    echo "Options:"
    echo "  -s, --security     Only check for security updates."
    echo "  -m, --mail         Mail root@localhost instead of printing results."
    exit 1
}

# Parse command-line arguments
while [ $# -gt 0 ] ; do
    case "$1" in
    "-s"|"--security")
        SECURITY=true
        shift
        ;;
    "-m"|"--mail")
        MAIL=true
        shift
        ;;
    "-?"|"-h"|"--help")
        usage
        ;;
    *)
        fail "invalid command-line argument: $1"
        ;;
    esac
done

# Check for root user
[ `whoami` == 'root' ] || fail "only root is allowed to run simple-uptodate"

# Check for update
export DEBIAN_FRONTEND="noninteractive"
apt-get --yes update > /dev/null || fail "couldn't update package lists with apt-get"
apt-get --yes clean || true
if $SECURITY ; then
    TYPE="security updates"
    SEARCH='~U ~Asecurity'
else
    TYPE="updates"
    SEARCH='~U'
fi
OUTFILE=/tmp/simple-uptodate.txt
aptitude search -F '%16p# %V# -- %d' "$SEARCH" > $OUTFILE || fail "couldn't search for $TYPE"
FOUND=`cat $OUTFILE | wc -l`
if [ $FOUND -ne 0 ] ; then
    if $MAIL ; then
        printf "Subject: System $TYPE for $HOST\n\n" > $OUTFILE.1
        printf "Found $FOUND system $TYPE for $HOST:\n\n" > $OUTFILE.2
        cat $OUTFILE.1 $OUTFILE.2 $OUTFILE | $SENDMAIL root
        rm $OUTFILE.1 $OUTFILE.2
    else
        printf "Found $FOUND system $TYPE for $HOST:\n\n"
        cat $OUTFILE
    fi
fi
rm $OUTFILE
