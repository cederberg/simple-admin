#!/bin/sh
#
# Checks the status of the services on this machine.
#
# Syntax: admin-status
#
# Files:
#   /etc/admin-status.conf
#

# Configuration variables
CONFIG=/etc/admin-status.conf
LOCALDIR=`dirname $0`/..

# Function for checking the service status
checkstatus() {
    NAME=$1
    PIDFILE=$2
    if [ -f "$PIDFILE" ] ; then
        PID=`cat $PIDFILE`
        ps -p $PID > /dev/null
        if [ $? -eq 0 ] ; then
            return 0
        fi
    fi
    ps -e | grep $NAME > /dev/null
    if [ $? -eq 0 ] ; then
        return 1
    else
        return 2
    fi
}

# Load config to stdin
if [ -f $CONFIG ] ; then
    exec < $CONFIG
elif [ -f $LOCALDIR/$CONFIG ] ; then
    exec < $LOCALDIR/$CONFIG
else
    echo "ERROR: Missing config file $CONFIG"
    exit 1
fi

# Checking all services
RETVAL=0
while read NAME PIDFILE ; do
    printf " * %-10s " "$NAME:"
    checkstatus $NAME $PIDFILE
    STATUS=$?
    if [ $STATUS -eq 0 ] ; then
        echo "OK"
    elif [ $STATUS -eq 1 ] ; then
        echo "ERROR -- invalid PID file $PIDFILE"
        RETVAL=`expr $RETVAL + 1`
    else
        echo "ERROR -- service not running"
        RETVAL=`expr $RETVAL + 1`
    fi
done
exit $RETVAL
